const kanaMap = {
    a: { hiragana: ["„ÅÇ", "„ÅÑ", "„ÅÜ", "„Åà", "„Åä"], katakana: ["„Ç¢", "„Ç§", "„Ç¶", "„Ç®", "„Ç™"], roma: ["a", "i", "u", "e", "o"] },
    k: { hiragana: ["„Åã", "„Åç", "„Åè", "„Åë", "„Åì"], katakana: ["„Ç´", "„Ç≠", "„ÇØ", "„Ç±", "„Ç≥"], roma: ["ka", "ki", "ku", "ke", "ko"] },
    s: { hiragana: ["„Åï", "„Åó", "„Åô", "„Åõ", "„Åù"], katakana: ["„Çµ", "„Ç∑", "„Çπ", "„Çª", "„ÇΩ"], roma: ["sa", "shi", "su", "se", "so"] },
    t: { hiragana: ["„Åü", "„Å°", "„Å§", "„Å¶", "„Å®"], katakana: ["„Çø", "„ÉÅ", "„ÉÑ", "„ÉÜ", "„Éà"], roma: ["ta", "chi", "tsu", "te", "to"] },
    n: { hiragana: ["„Å™", "„Å´", "„Å¨", "„Å≠", "„ÅÆ"], katakana: ["„Éä", "„Éã", "„Éå", "„Éç", "„Éé"], roma: ["na", "ni", "nu", "ne", "no"] },
    h: { hiragana: ["„ÅØ", "„Å≤", "„Åµ", "„Å∏", "„Åª"], katakana: ["„Éè", "„Éí", "„Éï", "„Éò", "„Éõ"], roma: ["ha", "hi", "fu", "he", "ho"] },
    m: { hiragana: ["„Åæ", "„Åø", "„ÇÄ", "„ÇÅ", "„ÇÇ"], katakana: ["„Éû", "„Éü", "„É†", "„É°", "„É¢"], roma: ["ma", "mi", "mu", "me", "mo"] },
    y: { hiragana: ["„ÇÑ", "„ÇÜ", "„Çà"], katakana: ["„É§", "„É¶", "„É®"], roma: ["ya", "yu", "yo"] },
    r: { hiragana: ["„Çâ", "„Çä", "„Çã", "„Çå", "„Çç"], katakana: ["„É©", "„É™", "„É´", "„É¨", "„É≠"], roma: ["ra", "ri", "ru", "re", "ro"] },
    w: { hiragana: ["„Çè", "„Çí", "„Çì"], katakana: ["„ÉØ", "„É≤", "„É≥"], roma: ["wa", "wo", "n"] }
};

let correct = 0, wrong = 0, total = 0;
let currentAnswer = "";
let timer;
let scrambleInterval;

// === C√ÅC BI·∫æN M·ªöI CHO √ÇM THANH (WEB SPEECH API) ===
let audioEnabled = true; // M·∫∑c ƒë·ªãnh b·∫≠t √¢m thanh
const synth = window.speechSynthesis;
// T√¨m gi·ªçng Nh·∫≠t B·∫£n (ja-JP) ƒë·ªÉ ph√°t √¢m ch√≠nh x√°c
let voice = null;
if (synth) {
    synth.onvoiceschanged = () => {
        voice = synth.getVoices().find(v => v.lang === 'ja-JP') || null;
    };
    if (synth.getVoices().length > 0) {
        voice = synth.getVoices().find(v => v.lang === 'ja-JP') || null;
    }
}

// === H√ÄM PH√ÅT √ÇM M·ªöI ===
function speakKana(kana) {
    if (!audioEnabled || !synth) return;

    // H·ªßy b·ªè gi·ªçng n√≥i ƒëang ch·∫°y (n·∫øu c√≥)
    if (synth.speaking) {
        synth.cancel();
    }

    const utterance = new SpeechSynthesisUtterance(kana);
    utterance.lang = 'ja-JP';
    
    let qMode = document.getElementById("questionMode").value;

    if(qMode === 'toKana'){
        utterance.lang = 'en-US';
        voice = synth.getVoices().find(v => v.lang === 'en-US') || null;
    }else{
        utterance.lang = 'ja-JP';
        voice = synth.getVoices().find(v => v.lang === 'ja-JP') || null;
    }

    if (voice) {
        utterance.voice = voice;
    }
    utterance.rate = 0.8;

    synth.speak(utterance);
}

// === X·ª¨ L√ù N√öT B·∫¨T/T·∫ÆT √ÇM THANH ===
document.getElementById("toggleAudioBtn").addEventListener('click', function () {
    audioEnabled = !audioEnabled;
    if (audioEnabled) {
        this.textContent = 'üîä';
    } else {
        this.textContent = 'üîá';
        if (synth && synth.speaking) {
            synth.cancel(); // T·∫Øt √¢m thanh ƒëang ph√°t
        }
    }
});

const groupKeys = Object.keys(kanaMap);

function renderGroupSwitches() {
    const container = document.getElementById("groupSwitches");
    container.innerHTML = "";

    const rows = [
        { id: 'row-1', keys: groupKeys.slice(0, 5) },  // 5 items
        { id: 'row-2', keys: groupKeys.slice(5, 10) } // 5 items
    ];

    // X·ª≠ l√Ω b·ªë c·ª•c Desktop: Chuy·ªÉn t·∫•t c·∫£ v·ªÅ row-1 duy nh·∫•t (Flex-wrap)
    if (window.innerWidth >= 768) {
        const rowDiv = document.createElement("div");
        rowDiv.className = "group-row";
        rowDiv.id = 'row-1';

        groupKeys.forEach(key => {
            const div = document.createElement("div");
            div.className = "switch-container";
            const isChecked = document.querySelector(`.groupFilter[value="${key}"]`) ? document.querySelector(`.groupFilter[value="${key}"]`).checked : true;
            div.innerHTML = `<label class="switch"><input type="checkbox" class="groupFilter" value="${key}" ${isChecked ? 'checked' : ''}><span class="slider"></span></label><span class="switch-label">${key}</span>`;
            rowDiv.appendChild(div);
        });
        container.appendChild(rowDiv);
        // ƒê·∫£m b·∫£o ch·ªâ c√≥ row-1 hi·ªÉn th·ªã tr√™n desktop
        document.getElementById('row-2')?.remove();
    }
    // X·ª≠ l√Ω b·ªë c·ª•c Mobile: 5x2 (Grid)
    else {
        rows.forEach(rowInfo => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "group-row";
            rowDiv.id = rowInfo.id;

            rowInfo.keys.forEach(key => {
                const div = document.createElement("div");
                div.className = "switch-container";
                const isChecked = document.querySelector(`.groupFilter[value="${key}"]`) ? document.querySelector(`.groupFilter[value="${key}"]`).checked : true;
                div.innerHTML = `<label class="switch"><input type="checkbox" class="groupFilter" value="${key}" ${isChecked ? 'checked' : ''}><span class="slider"></span></label><span class="switch-label">${key}</span>`;
                rowDiv.appendChild(div);
            });
            container.appendChild(rowDiv);
        });
        // X√≥a row-3 c≈© n·∫øu n√≥ t·ªìn t·∫°i
        document.getElementById('row-3')?.remove();
    }
}

function getSelectedGroups() {
    return [...document.querySelectorAll('.groupFilter:checked')].map(cb => cb.value);
}

function scrambleText(element, finalText, duration = 1500, qMode = "toRoma", mode = "hiragana", groups = [], onComplete) {
    clearInterval(scrambleInterval);
    let chars = "";

    groups.forEach(g => {
        if (qMode === "toRoma") {
            chars += kanaMap[g][mode].join("");
        } else {
            chars += kanaMap[g].roma.join("");
        }
    });

    if (qMode !== "toRoma") {
        chars = [...new Set(chars)].join('');
    }

    let elapsed = 0;
    const interval = 80;
    scrambleInterval = setInterval(() => {
        let display = "";
        let displayLength = 1;

        for (let i = 0; i < displayLength; i++) {
            display += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        element.textContent = display;

        elapsed += interval;
        if (elapsed >= duration) {
            clearInterval(scrambleInterval);
            element.textContent = finalText;
            speakKana(finalText);
            if (onComplete) onComplete();
        }
    }, interval);
}

function startGame() {
    clearTimeout(timer);

    document.querySelectorAll(".answers button").forEach(btn => {
        btn.disabled = false;
        btn.classList.remove("correct", "wrong");
        btn.textContent = "";
    });

    let mode = document.getElementById("mode").value;
    let qMode = document.getElementById("questionMode").value;
    let groups = getSelectedGroups();
    if (groups.length === 0) { alert("Ch·ªçn √≠t nh·∫•t 1 nh√≥m"); return; }

    let group = groups[Math.floor(Math.random() * groups.length)];
    let idx = Math.floor(Math.random() * kanaMap[group].roma.length);
    let kanaChar = kanaMap[group][mode][idx];
    let romaChar = kanaMap[group].roma[idx];

    currentAnswer = (qMode === "toRoma" ? romaChar : kanaChar);
    let questionDisplay = (qMode === "toRoma" ? kanaChar : romaChar);

    const kanaElem = document.getElementById("kana");

    let answers = [currentAnswer];
    const allPossibleAnswers = groups.flatMap(g =>
        (qMode === "toRoma" ? kanaMap[g].roma : kanaMap[g][mode])
    ).filter(ans => ans !== currentAnswer);

    allPossibleAnswers.sort(() => Math.random() - 0.5);
    const incorrectAnswers = allPossibleAnswers.slice(0, 3);
    answers = [...answers, ...incorrectAnswers];

    answers.sort(() => Math.random() - 0.5);

    let buttonAnsShowed = document.getElementsByClassName("switch-show-hide");

    let isButtonChecked = buttonAnsShowed.checked;

    const onAnimationComplete = () => {
        answers.forEach((ans, i) => { document.getElementById("btn" + i).textContent = ans; });
        document.getElementById("status").textContent = !isButtonChecked ? "ƒêang ƒë·ª£i c√¢u tr·∫£ l·ªùi" : "Ch·ªçn ƒë√°p √°n ƒë√∫ng!";

        timer = setTimeout(() => {
            wrong++;
            document.getElementById("wrong").textContent = wrong;

            document.querySelectorAll(".answers button").forEach(btn => {
                if (btn.textContent === currentAnswer) {
                    btn.classList.add("correct");
                }
            });

            document.getElementById("status").textContent = "‚è∞ H·∫øt gi·ªù! ƒê√°p √°n ƒë√∫ng: " + currentAnswer;
            document.querySelectorAll(".answers button").forEach(btn => btn.disabled = true);
        }, document.getElementById("thinkTime").value * 1000);
    };

    scrambleText(kanaElem, questionDisplay, 1500, qMode, mode, groups, onAnimationComplete);

    total++;
    document.getElementById("total").textContent = total;
    document.getElementById("status").textContent = "ƒêang t·∫£i c√¢u h·ªèi...";
}

function chooseAnswer(i) {
    clearTimeout(timer);
    let btn = document.getElementById("btn" + i);

    document.querySelectorAll(".answers button").forEach(b => b.disabled = true);

    if (btn.textContent === currentAnswer) {
        correct++;
        btn.classList.add("correct");
        document.getElementById("status").textContent = "üéâ ƒê√∫ng!";
    } else {
        wrong++;
        btn.classList.add("wrong");

        document.querySelectorAll(".answers button").forEach(correctBtn => {
            if (correctBtn.textContent === currentAnswer) {
                correctBtn.classList.add("correct");
            }
        });

        document.getElementById("status").textContent = `‚ùå Sai! ƒê√°p √°n ƒë√∫ng: ${currentAnswer}`;
    }

    document.getElementById("correct").textContent = correct;
    document.getElementById("wrong").textContent = wrong;
}

function resetGame() {
    correct = wrong = total = 0;
    document.getElementById("correct").textContent = 0;
    document.getElementById("wrong").textContent = 0;
    document.getElementById("total").textContent = 0;
    document.getElementById("status").textContent = "Nh·∫•n B·∫Øt ƒë·∫ßu cho c√¢u ti·∫øp theo.";
    const kanaElem = document.getElementById("kana");
    kanaElem.textContent = "?";
    clearInterval(scrambleInterval);
    document.querySelectorAll(".answers button").forEach(btn => { btn.textContent = ""; btn.classList.remove("correct", "wrong"); btn.disabled = false; });
}

renderGroupSwitches();

function toggleShowHideAns(t) {
    var isChecked = t.checked;
    var answerList = document.getElementById("answersBox");

    answerList.classList.toggle("hide");
}

// Th√™m listener ƒë·ªÉ g·ªçi l·∫°i render khi resize (chuy·ªÉn ƒë·ªïi mobile/desktop)
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        renderGroupSwitches();
    }, 100);
});