<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Mini Game Kana</title>

  <link rel="manifest" href="icons/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="KanaGame"> 
  
  <style>
    body { background:#0f172a; color:#f1f5f9; font-family:sans-serif; text-align:center; margin:0; padding:20px; }
    .game-box{ margin:30px auto; padding:20px; background:#1e293b; border-radius:12px; width:750px; max-width:95%; box-shadow:0 4px 12px rgba(0,0,0,0.4); }
    h2{ margin-top:0; color:#facc15; }
    .kana{ font-size:90px; margin:20px; min-height:100px; display:flex; align-items:center; justify-content:center; font-weight:bold; letter-spacing:3px; }
    .scramble { display:inline-block; }
    .answers{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:20px; }
    button{ padding:12px; font-size:20px; border:none; border-radius:8px; cursor:pointer; background:#334155; color:#f1f5f9; transition:all 0.25s; }
    button:hover:not(:disabled){ background:#475569; transform:scale(1.02); }
    button:disabled{ cursor:not-allowed; opacity:0.7; }
    .correct{ background:#10b981!important; color:white!important; }
    .wrong{ background:#ef4444!important; color:white!important; }
    .options{ display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
    .score{ display:flex; justify-content:space-around; margin-top:15px; font-size:18px; font-weight:bold; }
    .score span{ padding:8px 12px; border-radius:6px; }
    #correct-count{ color:#10b981; }
    #wrong-count{ color:#ef4444; }
    #total-count{ color:#facc15; }
    #status{ margin-top:15px; font-style:italic; min-height:24px; }
    .group-switches{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px; }
    .group-switches label{ display:flex; align-items:center; gap:5px; font-size:16px; cursor:pointer; }
    #toggleAudioBtn{ position:absolute; top:20px; left:20px; background:#facc15; color:#1e293b; font-weight:bold; padding:8px 15px; border-radius:6px; font-size:16px; }

    /* Keyframes cho hi·ªáu ·ª©ng Scramble */
    @keyframes scramble {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(-5px) rotate(3deg); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="game-box">
    <button id="toggleAudioBtn">üîä B·∫≠t √¢m thanh</button>
    
    <h2>Mini Game Kana</h2>
    <div class="options">
      <button onclick="startNewQuestion()">B·∫Øt ƒë·∫ßu</button>
      <button onclick="resetGame()">Ch∆°i l·∫°i</button>
      <div>
        <label for="thinkTime">Th·ªùi gian nghƒ© (gi√¢y):</label>
        <input type="number" id="thinkTime" value="10" min="5" max="60" style="width:50px; padding:5px; border-radius:4px; border:none;">
      </div>
    </div>
    
    <div class="group-switches" id="groupSwitches">
      </div>
    
    <div class="kana" id="kana">?</div>
    
    <div class="answers" id="answers">
      <button id="btn1" onclick="chooseAnswer(1)"></button>
      <button id="btn2" onclick="chooseAnswer(2)"></button>
      <button id="btn3" onclick="chooseAnswer(3)"></button>
      <button id="btn4" onclick="chooseAnswer(4)"></button>
    </div>
    
    <div class="score">
      <span id="status">Nh·∫•n B·∫Øt ƒë·∫ßu ƒë·ªÉ ch∆°i.</span>
    </div>
    <div class="score" style="margin-top:5px; font-size:16px;">
      <span id="correct-count">ƒê√∫ng: <span id="correct">0</span></span>
      <span id="wrong-count">Sai: <span id="wrong">0</span></span>
      <span id="total-count">T·ªïng: <span id="total">0</span></span>
    </div>

  </div>

  <script>
    const KANA_GROUPS = {
      hiragana: "„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åå„Åé„Åê„Åí„Åî„Åï„Åó„Åô„Åõ„Åù„Åñ„Åò„Åö„Åú„Åû„Åü„Å°„Å§„Å¶„Å®„Å†„Å¢„Å•„Åß„Å©„Å™„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Å∞„Å≥„Å∂„Åπ„Åº„Å±„Å¥„Å∑„Å∫„ÅΩ„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã„Çå„Çç„Çè„Çí„Çì",
      katakana: "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Ç¨„ÇÆ„Ç∞„Ç≤„Ç¥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Ç∂„Ç∏„Ç∫„Çº„Çæ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„ÉÄ„ÉÇ„ÉÖ„Éá„Éâ„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éê„Éí„Éñ„Éô„Éõ„Éë„Éî„Éó„Éö„Éù„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥",
      romaji: "a i u e o ka ki ku ke ko ga gi gu ge go sa shi su se so za ji zu ze zo ta chi tsu te to da ji zu de do na ni nu ne no ha hi fu he ho ba bi bu be bo pa pi pu pe po ma mi mu me mo ya yu yo ra ri ru re ro wa o n"
    };

    let selectedKana = KANA_GROUPS.hiragana;
    let selectedRomaji = KANA_GROUPS.romaji.split(" ");
    let currentAnswer = "";
    let correct = 0;
    let wrong = 0;
    let total = 0;
    let timer;
    let scrambleInterval;
    
    // === C√ÅC BI·∫æN M·ªöI CHO √ÇM THANH (WEB SPEECH API) ===
    let audioEnabled = true; 
    const synth = window.speechSynthesis;
    // T√¨m gi·ªçng Nh·∫≠t B·∫£n n·∫øu c√≥
    let voice = null;
    if (synth) {
      synth.onvoiceschanged = () => {
        voice = synth.getVoices().find(v => v.lang === 'ja-JP') || null;
      };
      // G·ªçi ngay l·∫≠p t·ª©c n·∫øu voices ƒë√£ s·∫µn s√†ng
      if (synth.getVoices().length > 0) {
        voice = synth.getVoices().find(v => v.lang === 'ja-JP') || null;
      }
    }


    // === H√ÄM PH√ÅT √ÇM M·ªöI ===
    function speakKana(kana) {
      if (!audioEnabled || !synth) return;
      
      if (synth.speaking) {
        synth.cancel();
      }

      const utterance = new SpeechSynthesisUtterance(kana);
      utterance.lang = 'ja-JP';
      if (voice) {
        utterance.voice = voice;
      }
      utterance.rate = 0.8;
      
      synth.speak(utterance);
    }

    // === X·ª¨ L√ù N√öT B·∫¨T/T·∫ÆT √ÇM THANH ===
    document.getElementById("toggleAudioBtn").addEventListener('click', function() {
      audioEnabled = !audioEnabled;
      if (audioEnabled) {
        this.textContent = 'üîä B·∫≠t √¢m thanh';
      } else {
        this.textContent = 'üîá T·∫Øt √¢m thanh';
        if (synth && synth.speaking) {
          synth.cancel(); 
        }
      }
    });
    
    
    function scrambleEffect(kana){
      const kanaElem = document.getElementById("kana");
      const duration = 750;
      let startTime;

      function animate(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const scrambleCount = Math.floor(progress / 50);

        if (progress < duration) {
          if (scrambleCount % 2 === 0) {
            kanaElem.textContent = KANA_GROUPS.hiragana[Math.floor(Math.random() * KANA_GROUPS.hiragana.length)];
          } else {
            kanaElem.textContent = KANA_GROUPS.katakana[Math.floor(Math.random() * KANA_GROUPS.katakana.length)];
          }
          requestAnimationFrame(animate);
        } else {
          // Hi·ªáu ·ª©ng ho√†n th√†nh
          kanaElem.textContent = kana;
          speakKana(kana); // PH√ÅT √ÇM
        }
      }

      requestAnimationFrame(animate);
    }
    
    function startNewQuestion(){
      total++;
      document.getElementById("total").textContent=total;
      document.getElementById("status").textContent="Ch·ªçn ƒë√°p √°n ƒë√∫ng!";
      document.querySelectorAll(".answers button").forEach(btn=>{btn.classList.remove("correct","wrong");btn.disabled=false;});
      
      const kanaIndex = Math.floor(Math.random()*selectedKana.length);
      const randomKana = selectedKana[kanaIndex];
      currentAnswer = selectedRomaji[kanaIndex];
      
      scrambleEffect(randomKana); // CH·∫†Y HI·ªÜU ·ª®NG V√Ä PH√ÅT √ÇM

      let answers = [currentAnswer];
      while(answers.length < 4){
        const randomIndex = Math.floor(Math.random()*selectedRomaji.length);
        const wrongAnswer = selectedRomaji[randomIndex];
        if(!answers.includes(wrongAnswer)){
          answers.push(wrongAnswer);
        }
      }
      
      answers.sort(()=>Math.random()-0.5);
      
      document.getElementById("btn1").textContent=answers[0];
      document.getElementById("btn2").textContent=answers[1];
      document.getElementById("btn3").textContent=answers[2];
      document.getElementById("btn4").textContent=answers[3];

      clearTimeout(timer);
      timer = setTimeout(()=>{
        wrong++;
        document.getElementById("wrong").textContent=wrong;
        document.getElementById("status").textContent="‚è∞ H·∫øt gi·ªù! ƒê√°p √°n ƒë√∫ng: "+currentAnswer;
        document.querySelectorAll(".answers button").forEach(btn=>btn.disabled=true);
        speakKana(randomKana); // PH√ÅT √ÇM KHI H·∫æT GI·ªú
      }, document.getElementById("thinkTime").value*1000);
    }

    function chooseAnswer(i){
      clearTimeout(timer);
      const kanaToSpeak = document.getElementById("kana").textContent;
      let btn=document.getElementById("btn"+i);
      
      if(btn.textContent===currentAnswer){
        correct++;
        btn.classList.add("correct");
        document.getElementById("status").textContent="üéâ ƒê√∫ng!";
        speakKana(kanaToSpeak); // PH√ÅT √ÇM KHI TR·∫¢ L·ªúI ƒê√öNG
      } else {
        wrong++;
        btn.classList.add("wrong");
        document.getElementById("status").textContent="‚ùå Sai! ƒê√°p √°n ƒë√∫ng: "+currentAnswer;
        speakKana(kanaToSpeak); // PH√ÅT √ÇM KHI TR·∫¢ L·ªúI SAI
      }
      
      document.getElementById("correct").textContent=correct;
      document.getElementById("wrong").textContent=wrong;
      document.querySelectorAll(".answers button").forEach(b=>b.disabled=true);
    }

    function renderGroupSwitches(){
      const groupNames = Object.keys(KANA_GROUPS).filter(name => name !== 'romaji');
      const container = document.getElementById('groupSwitches');
      container.innerHTML = 'Ch·ªçn nh√≥m Kana: ';
      
      groupNames.forEach(group => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = group;
        checkbox.checked = true;
        checkbox.addEventListener('change', updateKanaSet);
        
        const label = document.createElement('label');
        label.htmlFor = group;
        label.textContent = group.charAt(0).toUpperCase() + group.slice(1);
        
        container.appendChild(label);
        container.appendChild(checkbox);
      });
      updateKanaSet();
    }

    function updateKanaSet(){
      let newKana = '';
      let newRomaji = [];
      
      if (document.getElementById('hiragana') && document.getElementById('hiragana').checked) {
        newKana += KANA_GROUPS.hiragana;
        newRomaji = newRomaji.concat(KANA_GROUPS.romaji.split(' '));
      }
      if (document.getElementById('katakana') && document.getElementById('katakana').checked) {
        newKana += KANA_GROUPS.katakana;
        newRomaji = newRomaji.concat(KANA_GROUPS.romaji.split(' '));
      }
      
      if (newKana.length === 0) {
        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√≥m Kana!");
        document.getElementById('hiragana').checked = true;
        updateKanaSet();
        return;
      }

      selectedKana = newKana;
      selectedRomaji = [...new Set(newRomaji)];
      resetGame();
    }

    function resetGame(){
      correct=wrong=total=0;
      document.getElementById("correct").textContent=0;
      document.getElementById("wrong").textContent=0;
      document.getElementById("total").textContent=0;
      document.getElementById("status").textContent="Nh·∫•n B·∫Øt ƒë·∫ßu cho c√¢u ti·∫øp theo.";
      const kanaElem=document.getElementById("kana");
      kanaElem.textContent="?";
      document.querySelectorAll(".answers button").forEach(btn=>{btn.textContent="";btn.classList.remove("correct","wrong");btn.disabled=false;});
      clearTimeout(timer);
      if (synth && synth.speaking) {
        synth.cancel(); // H·ªßy gi·ªçng n√≥i khi reset game
      }
    }

    renderGroupSwitches();
  </script>
</body>
</html>
